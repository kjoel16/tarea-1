using System;
using System.Net.Http;
using System.Threading.Tasks;
using System.Threading;

namespace PinBuzonInteligente
{
    internal class Program
    {
        // URL a monitorear (c√°mbiala por la tuya)
        private static readonly string Url = "https://tuservicio.com/api/health";

        // Intervalo de verificaci√≥n en milisegundos (por ejemplo, cada 10 segundos)
        private static readonly int IntervaloPing = 10000;

        // Cliente HTTP reutilizable (mejor rendimiento)
        private static readonly HttpClient HttpClient = new HttpClient();

        static async Task Main(string[] args)
        {
            Console.WriteLine("üü¢ Iniciando monitor de servicio...");
            Console.WriteLine($"URL objetivo: {Url}");
            Console.WriteLine("Presiona CTRL + C para detener.\n");

            while (true)
            {
                try
                {
                    bool servicioActivo = await VerificarServicioAsync();

                    if (!servicioActivo)
                    {
                        Console.ForegroundColor = ConsoleColor.Red;
                        Console.WriteLine($"‚ùå [{DateTime.Now}] Servicio no disponible.");
                        Console.ResetColor();

                        // Llamada al m√©todo de acci√≥n cuando el servicio est√° ca√≠do
                        await OnServicioCaidoAsync();
                    }
                    else
                    {
                        Console.ForegroundColor = ConsoleColor.Green;
                        Console.WriteLine($"‚úÖ [{DateTime.Now}] Servicio activo.");
                        Console.ResetColor();
                    }
                }
                catch (Exception ex)
                {
                    Console.ForegroundColor = ConsoleColor.Yellow;
                    Console.WriteLine($"‚ö†Ô∏è Error durante la verificaci√≥n: {ex.Message}");
                    Console.ResetColor();
                }

                await Task.Delay(IntervaloPing);
            }
        }

        /// <summary>
        /// Realiza una solicitud GET para verificar si el servicio responde correctamente.
        /// </summary>
        private static async Task<bool> VerificarServicioAsync()
        {
            try
            {
                HttpResponseMessage response = await HttpClient.GetAsync(Url);
                return response.IsSuccessStatusCode;
            }
            catch
            {
                // Cualquier excepci√≥n (timeout, DNS, conexi√≥n) se considera ca√≠da
                return false;
            }
        }

        /// <summary>
        /// M√©todo que se ejecuta cuando el servicio no responde.
        /// Aqu√≠ ir√° tu l√≥gica de env√≠o, logging o notificaci√≥n.
        /// </summary>
        private static async Task OnServicioCaidoAsync()
        {
            // TODO: Aqu√≠ agregas tu l√≥gica personalizada
            // Por ejemplo, llamada a otro servicio:
            // await LlamarServicioEnvioAsync();

            Console.WriteLine("‚öôÔ∏è Ejecutando acci√≥n por servicio ca√≠do...\n");
            await Task.CompletedTask;
        }
    }
}