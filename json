package com.tu.paquete.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.Types;

import com.tu.paquete.connection.As400ConnectionService;
import com.tu.paquete.dto.ConsultaCuentaDataDTO;

@Service
public class ConsultaCuentaService {

    @Autowired
    private As400ConnectionService connectionService;

    public ConsultaCuentaDataDTO consultarDatosCliente(String cuenta) {

        ConsultaCuentaDataDTO dto = new ConsultaCuentaDataDTO();

        String sql = "{CALL KJOELQDD.SP_DATOS_CLIENTE_CUENTA(?, ?, ?, ?, ?, ?, ?)}";

        try (Connection conn = connectionService.getJdbcConnection();
             CallableStatement cs = conn.prepareCall(sql)) {

            // IN
            cs.setString(1, cuenta);

            // OUT
            cs.registerOutParameter(2, Types.CHAR);     
            cs.registerOutParameter(3, Types.CHAR);     
            cs.registerOutParameter(4, Types.VARCHAR);  
            cs.registerOutParameter(5, Types.VARCHAR);  
            cs.registerOutParameter(6, Types.VARCHAR);  
            cs.registerOutParameter(7, Types.VARCHAR);  

            cs.execute();

            dto.setDmstat(safeTrim(cs.getString(2)));
            dto.setCunbr(safeTrim(cs.getString(3)));
            dto.setCuna1(cs.getString(4));
            dto.setTelefono(cs.getString(5));
            dto.setIdentidad(cs.getString(6));
            dto.setEmail(cs.getString(7));

        } catch (Exception e) {
            throw new RuntimeException("Error ejecutando SP_DATOS_CLIENTE_CUENTA", e);
        }

        return dto;
    }

    private String safeTrim(String value) {
        return value == null ? null : value.trim();
    }
}