package com.mycompany.api.transaccions.service;

import com.ibm.as400.access.AS400;
import com.ibm.as400.access.AS400SecurityException;
import com.ibm.as400.access.ErrorCompletingRequestException;
import com.mycompany.api.transaccions.config.As400Properties;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;

@Service
public class As400ConnectionService {

    @Autowired
    private As400Properties properties;

    public AS400 getConnection() {

        try {
            System.out.println("=== PROBANDO CONEXION AS400 ===");
            System.out.println("HOST: " + properties.getHost());
            System.out.println("USER: " + properties.getUser());
            System.out.println("PASS: " + properties.getPassword());

            // SIN DESENCRIPTAR
            AS400 as400 = new AS400(
                    properties.getHost(),
                    properties.getUser(),
                    properties.getPassword()
            );

            // Esto fuerza validación de credenciales
            as400.connectService(AS400.COMMAND);

            System.out.println("✅ Conexion exitosa al AS400");

            return as400;

        } catch (AS400SecurityException e) {
            throw new RuntimeException("❌ Usuario/Password incorrectos", e);

        } catch (ErrorCompletingRequestException e) {
            throw new RuntimeException("❌ No se pudo completar la conexion al AS400", e);

        } catch (IOException e) {
            throw new RuntimeException("❌ Error de red conectando al AS400", e);

        } catch (Exception e) {
            throw new RuntimeException("❌ Error general conectando al AS400", e);
        }
    }
}