package com.mycompany.api.consulta.service;

import com.ibm.as400.access.AS400JDBCDataSource;
import com.mycompany.api.consulta.config.As400Properties;
import com.mycompany.api.consulta.dto.dtosConsultaCuenta.ConsultaCuentaDataDTO;
import com.mycompany.api.consulta.dto.dtosConsultaCuenta.ConsultaCuentaResultDTO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.Types;

@Service
public class ConsultaCuentaService {

    @Autowired
    private As400Properties properties;

    public ConsultaCuentaResultDTO consultarDatosCliente(ConsultaCuentaDataDTO request) {

        ConsultaCuentaResultDTO dto = new ConsultaCuentaResultDTO();

        String sql = "{CALL BCAH96.SP_DATOS_CLIENTE_CUENTA(?, ?, ?, ?, ?, ?)}";

        try (
                Connection conn = getJdbcConnection();
                CallableStatement cs = conn.prepareCall(sql)
        ) {

            System.out.println("Ejecutando SP_DATOS_CLIENTE_CUENTA...");

            // PARAMETRO IN (NUMERIC)
            cs.setBigDecimal(1, new BigDecimal(request.getCuenta()));

            // PARAMETROS OUT
            cs.registerOutParameter(2, Types.CHAR);      // CUNBR
            cs.registerOutParameter(3, Types.VARCHAR);   // CUNA1
            cs.registerOutParameter(4, Types.DECIMAL);   // CUCLPH
            cs.registerOutParameter(5, Types.VARCHAR);   // CUNTID
            cs.registerOutParameter(6, Types.VARCHAR);   // CUEMA1

            cs.execute();

            dto.setCunbr(safeTrim(cs.getString(2)));
            dto.setCuna1(cs.getString(3));
            dto.setTelefono(
                    cs.getBigDecimal(4) != null
                            ? cs.getBigDecimal(4).toPlainString()
                            : null
            );
            dto.setIdentidad(cs.getString(5));
            dto.setEmail(cs.getString(6));

            dto.setCodErr("0000");
            dto.setDescErr("OK");

        } catch (Exception e) {

            e.printStackTrace();

            dto.setCodErr("9999");
            dto.setDescErr("ERROR EJECUTANDO SP");

        }

        return dto;
    }

    private Connection getJdbcConnection() throws Exception {

        AS400JDBCDataSource ds = new AS400JDBCDataSource();
        ds.setServerName(properties.getHost());
        ds.setUser(properties.getUser());
        ds.setPassword(properties.getPassword());

        return ds.getConnection();
    }

    private String safeTrim(String value) {
        return value == null ? null : value.trim();
    }
}