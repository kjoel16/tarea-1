builder.Services.AddHttpClient("mtls")
    .ConfigurePrimaryHttpMessageHandler(sp =>
    {
        var cfg = sp.GetRequiredService<IConfiguration>();

        var handler = new HttpClientHandler
        {
            ClientCertificateOptions = ClientCertificateOptions.Manual,
            SslProtocols = System.Security.Authentication.SslProtocols.Tls12
        };

        handler.ClientCertificates.Add(LoadFromStoreBySubjectName(cfg));

        // ⚠️ Solo para pruebas: aceptar cualquier cert de servidor
        handler.ServerCertificateCustomValidationCallback = 
            HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;

        return handler;
    });